<?xml version="1.0"?>

<transmogrifierConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     xsi:noNamespaceSchemaLocation="transmogrifier_config.xsd">

    <global minimumVersion="2.7.7"/>

    <project name="Simpson Lab: Fix LexA Line Names" default="true" taskName="simple-move">

        <inputFileFilter patternString="JHS_Lex.*lsm"
                         recursiveSearch="true"/>

        <outputDirectory>
            <path path="[\\dm11.janelia.priv\simpsonmicro|/groups/simpson/MicroscopeData]\Lex_confocal_stacks\" />
            <renameFieldValue fieldDisplayName="Line" />
        </outputDirectory>

        <plugins>
            <rowValidator className="org.janelia.it.ims.tmog.plugin.imagedb.ImagePathExistsValidator">
                <property name="db.config.key" value="sage"/>
            </rowValidator>

            <rowListener className="org.janelia.it.ims.tmog.plugin.imagedb.ImageDataPlugin">
                <property name="db.config.key" value="sage"/>
                <property name="exclude.host.name" value="true"/>
                <property name="family" value="$STATIC:simpson_lex"/>
                <property name="lab" value="$STATIC:simpson"/>
                <property name="line" value="Line"/>
                <property name="capture_date" value="Capture Date"/>
                <property name="organ" value="Organ$MAP:b=Brain|t=Thorax"/>
                <property name="uas_reporter" value="UAS Reporter"/>
            </rowListener>

            <sessionListener className="org.janelia.it.ims.tmog.plugin.SessionSummaryFileWriter">
                <property name="directory" value="[\\dm11.janelia.priv\simpsonmicro|/groups/simpson/MicroscopeData]\tmog\summaries\simpson_lex"/>
            </sessionListener>
        </plugins>

        <dataFields>

            <text displayName="Line" required="true" pattern="(JHS|EXT)_[0-9A-Za-z_-]+-LexA">
                <sourceFileMappedDefault pattern="(.*)_\d{8}_._\d{17}\.lsm">
                    <mappedValue from="JHS_LexAP001" to="JHS_P001-LexA"/>
                    <mappedValue from="JHS_LexAP004" to="JHS_P004-LexA"/>
                    <mappedValue from="JHS_LexAP005" to="JHS_P005-LexA"/>
                    <mappedValue from="JHS_LexAP009" to="JHS_P009-LexA"/>
                </sourceFileMappedDefault>
            </text>

            <separator value="_"/>

            <date displayName="Capture Date" required="true"
                  datePattern="yyyyMMdd">
                <sourceFileDateDefault pattern=".*_(\d{8})_.*"
                                       fromDatePattern="yyyyMMdd"
                                       toDatePattern="yyyyMMdd"/>
            </date>

            <separator value="_"/>

            <validValueList displayName="Organ" required="true">
                <sourceFileDefault pattern=".*_\d{8}_([bt]).*"/>
                <validValue displayName="b: Brain" value="b"/>
                <validValue displayName="t: Thorax" value="t"/>
            </validValueList>

            <text displayName="File Suffix" required="true"
                  pattern="_\d{17}\.lsm"
                  copyable="false">
                <sourceFileDefault pattern=".*(_\d{17}\.lsm)$"/>
            </text>

            <!--
             These values are collected for the database but are not
             included as components of the file name (markedForTask="false").
             -->
            <validValueList displayName="UAS Reporter" required="true"
                            markedForTask="false">
                <validValue value="pBDP-LexAop-CD2-GFP" default="true"/>
            </validValueList>

        </dataFields>

    </project>

    <project name="Simpson Lab: Rename Waffles">

        <inputFileFilter patternString=".*lsm"
                         recursiveSearch="true"/>

        <outputDirectory>
            <path path="[\\dm11.janelia.priv\simpsonmicro|/groups/simpson/MicroscopeData]\Waffles_confocal_stacks\" />
            <renameFieldValue fieldDisplayName="Line" />
        </outputDirectory>

        <plugins>
            <rowValidator className="org.janelia.it.ims.tmog.plugin.imagedb.ImagePathExistsValidator">
                <property name="db.config.key" value="sage"/>
                <property name="relativePathDepth" value="2"/>
            </rowValidator>

            <rowListener className="org.janelia.it.ims.tmog.plugin.imagedb.ImageSequencePlugin">
                <property name="db.config.key" value="sage" />
                <property name="Image Count" value="urn:lsid:janelia.org:simpson_waffles_uid" />
            </rowListener>

            <rowListener className="org.janelia.it.ims.tmog.plugin.imagedb.ImageDataPlugin">
                <property name="db.config.key" value="sage"/>
                <property name="exclude.host.name" value="true"/>
                <property name="previousRelativePathDepth" value="2"/>
                <property name="family" value="$STATIC:simpson_waffles"/>
                <property name="lab" value="$STATIC:simpson"/>
                <property name="line" value="Line"/>
                <property name="capture_date" value="Capture Date"/>
                <property name="organ" value="Organ$MAP:b=Brain|t=Thorax"/>
                <property name="uas_reporter" value="UAS Reporter"/>
            </rowListener>

            <sessionListener className="org.janelia.it.ims.tmog.plugin.SessionSummaryFileWriter">
                <property name="directory" value="[\\dm11.janelia.priv\simpsonmicro|/groups/simpson/MicroscopeData]\tmog\summaries\simpson_waffles"/>
            </sessionListener>
        </plugins>

        <dataFields>

            <text displayName="Line" required="true" pattern="(JHS|EXT)_[0-9A-Za-z_-]+-GAL4">
                <sourceFileMappedDefault pattern=".*confocal_stacks[/\\\\]([^/\\\\]*)[/\\\\].*"
                                         matchType="path">
                    <!-- NOTE: need to remove JHS_ prefix from Phuong's xls -->
                    <mappedValue from="WFL001_4W80_071808" to="JHS_Waffle_001-GAL4"/>
                    <mappedValue from="WFL003_4W80_071508" to="JHS_Waffle_003-GAL4"/>
                    <mappedValue from="WFL004_4W80_080108" to="JHS_Waffle_004-GAL4"/>
                </sourceFileMappedDefault>
            </text>

            <separator value="_"/>

            <date displayName="Capture Date" required="true"
                  datePattern="yyyyMMdd">
                <sourceFileDateDefault pattern=".*(\d{6})\.mdb.*"
                                       matchType="path"
                                       fromDatePattern="MMddyy"
                                       toDatePattern="yyyyMMdd"/>
            </date>

            <separator value="_"/>

            <validValueList displayName="Organ" required="true">
                <validValue displayName="b: Brain" value="b"/>
                <validValue displayName="t: Thorax" value="t"/>
            </validValueList>

            <separator value="_"/>

            <pluginData displayName="Image Count" format="%05d"/>

            <fileExtension/>
            
            <!--
             These values are collected for the database but are not
             included as components of the file name (markedForTask="false").
             -->
            <validValueList displayName="UAS Reporter" required="true"
                            markedForTask="false">
                <validValue value="UAS_mCD8-GFP" default="true"/>
            </validValueList>

        </dataFields>

    </project>

    <!-- TODO: create Optimizing config -->

    <project name="Simpson: IHC Optimizing from Nighthawk" taskName="collector">

        <inputFileFilter patternString=".*\.xml">
            <xmlPropertyFile targetGroupPath="data"
                             relativeTargetPath="row"
                             relativeTargetNamePath="path">

                <targetProperty relativePath="capture_date"/>
                <targetProperty relativePath="sage_line"/>
                <targetProperty relativePath="effector"/>
                <targetProperty relativePath="gender"/>
                <targetProperty relativePath="age"/>
                <targetProperty relativePath="mounting_protocol"/>
                <targetProperty relativePath="channels"/>
                <targetProperty relativePath="objective"/>
                <targetProperty relativePath="voxel_size_x"/>
                <targetProperty relativePath="voxel_size_y"/>
                <targetProperty relativePath="voxel_size_z"/>
                <targetProperty relativePath="dimension_x"/>
                <targetProperty relativePath="dimension_y"/>
                <targetProperty relativePath="dimension_z"/>
            </xmlPropertyFile>
        </inputFileFilter>

        <inputFileSorter sortAlgorithm="LNumber"/>

        <plugins>

            <rowListener className="org.janelia.it.ims.tmog.plugin.imagedb.ImageSequencePlugin">
                <property name="db.config.key" value="sage" />
                <property name="sample_number" value="urn:lsid:janelia.org:simpson_ihc_optimizing:sample_number" />
            </rowListener>

            <rowListener className="org.janelia.it.ims.tmog.plugin.imagedb.ImageDataPlugin">
                <property name="db.config.key" value="sage"/>
                <property name="exclude.host.name" value="true"/>
                <property name="keep.existing.data" value="true"/>
                <property name="lab" value="$STATIC:simpson"/>
                <property name="family" value="$STATIC:simpson_ihc_optimizing"/>
                <property name="relativePathDepth" value="3"/>
                <property name="line" value="sage_line"/>
                <property name="capture_date" value="capture_date"/>
                <property name="data_set" value="data_set"/>
                <property name="slide_code" value="ihc_sample_${sample_number}"/>
                <property name="tile" value="tile"/>
                <property name="area" value="area"/>
                <property name="channel_spec" value="channel_spec"/>
                <!--<property name="effector" value="effector"/>-->
                <!--<property name="gender" value="gender"/>-->
                <!--<property name="age" value="age"/>-->
                <!--<property name="mounting_protocol" value="mounting_protocol"/>-->
                <property name="channels" value="channels"/>
                <property name="objective" value="objective"/>
                <property name="voxel_size_x" value="voxel_size_x"/>
                <property name="voxel_size_y" value="voxel_size_y"/>
                <property name="voxel_size_z" value="voxel_size_z"/>
                <property name="dimension_x" value="dimension_x"/>
                <property name="dimension_y" value="dimension_y"/>
                <property name="dimension_z" value="dimension_z"/>
                <property name="base_path" value="$STATIC:/groups/simpson/MicroscopeData/Immunohistochemistry_Optimizing/"/>
            </rowListener>

        </plugins>

        <dataFields>
            <pluginData displayName="sample_number" format="%06d"/>
            <date displayName="capture_date" required="true" datePattern="yyyy-MM-dd HH:mm:ss">
                <targetPropertyDefault propertyName="capture_date"/>
            </date>
            <text displayName="data_set" required="true"><staticDefault value="knappj_ihc_optimizing"/></text>
            <text displayName="tile" required="true"><staticDefault value="brain"/></text>
            <text displayName="area" required="true"><staticDefault value="Brain"/></text>
            <text displayName="channel_spec" required="true"><staticDefault value="rs"/></text>
            <webServiceList displayName="sage_line" required="true"
                            valueCreationPath="*/line"
                            relativeActualValuePath="name"
                            relativeValueDisplayNamePath="name"
                            serviceUrl="http://sage.int.janelia.org/sage-ws/lines/forMultipleLabs.janelia-sage?lab=fly&amp;lab=flylight&amp;lab=rubin&amp;lab=jayaraman&amp;lab=simpson&amp;lab=leet&amp;lab=zlatic"
                            autoComplete="true">
                <targetPropertyDefault propertyName="sage_line"/>
            </webServiceList>
            <!--<text displayName="effector" required="false"><targetPropertyDefault propertyName="effector"/></text>-->
            <!--<text displayName="gender" required="false"><targetPropertyDefault propertyName="gender"/></text>-->
            <!--<text displayName="age" required="false"><targetPropertyDefault propertyName="age"/></text>-->
            <!--<text displayName="mounting_protocol" required="false"><targetPropertyDefault propertyName="mounting_protocol"/></text>-->
            <text displayName="channels" required="true"><targetPropertyDefault propertyName="channels"/></text>
            <text displayName="objective" required="true"><targetPropertyDefault propertyName="objective"/></text>
            <text displayName="voxel_size_x" required="true"><targetPropertyDefault propertyName="voxel_size_x"/></text>
            <text displayName="voxel_size_y" required="true"><targetPropertyDefault propertyName="voxel_size_y"/></text>
            <text displayName="voxel_size_z" required="true"><targetPropertyDefault propertyName="voxel_size_z"/></text>
            <text displayName="dimension_x" required="true"><targetPropertyDefault propertyName="dimension_x"/></text>
            <text displayName="dimension_y" required="true"><targetPropertyDefault propertyName="dimension_y"/></text>
            <text displayName="dimension_z" required="true"><targetPropertyDefault propertyName="dimension_z"/></text>
        </dataFields>

    </project>

</transmogrifierConfiguration>